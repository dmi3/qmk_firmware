// Copyright 2020 QMK
// SPDX-License-Identifier: GPL-2.0-or-later
#include QMK_KEYBOARD_H
#include <string.h>
#include "raw_hid.h"

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {
    LAYOUT(KC_BTN3, KC_E, KC_MEDIA_PLAY_PAUSE, KC_C, KC_MEDIA_NEXT_TRACK, KC_D)
};

// https://github.com/qmk/qmk_firmware/blob/master/docs/feature_encoders.md
bool encoder_update_user(uint8_t index, bool clockwise) {
  if (index == 0) { /* First encoder */
      if (clockwise) {
        tap_code_delay(KC_WH_U, 10);
      } else {
        tap_code_delay(KC_WH_D, 10);
      }
  } else if (index == 1) { /* Second encoder */
      if (clockwise) {
          tap_code_delay(KC_VOLU, 10);
      } else {
          tap_code_delay(KC_VOLD, 10);
      }
  }

  return true;
}


// https://github.com/qmk/qmk_firmware/blob/master/docs/feature_oled_driver.md
// https://docs.splitkb.com/hc/en-us/articles/360013811280-How-do-I-convert-an-image-for-use-on-an-OLED-display-
#ifdef OLED_ENABLE

oled_rotation_t oled_init_user(oled_rotation_t rotation) { return OLED_ROTATION_180; }

static void render_logo(void) {
    static const char PROGMEM qmk_logo[] = {
// 'cyberpunk_chinese', 128x32px
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xa0, 0xa0,
0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0, 0xe0, 0xe0, 0xe0, 0xe0, 0xa0, 0xa0, 0xa0, 0xa0, 0xa0,
0xa0, 0xa0, 0xa0, 0x20, 0x20, 0x20, 0x00, 0x00, 0xc0, 0xe0, 0xe0, 0xe0, 0x20, 0xa0, 0xa0, 0xa0,
0xa0, 0x20, 0x20, 0x20, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x80,
0x00, 0x00, 0xc0, 0xc0, 0xc0, 0x00, 0xc0, 0xe0, 0xe0, 0x00, 0x80, 0xe0, 0xe0, 0x00, 0xc0, 0xc0,
0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0,
0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0,
0xc0, 0xc0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x18, 0xcc, 0xee, 0xe7, 0x63, 0x69,
0x68, 0x6a, 0xe2, 0xe2, 0xe8, 0xec, 0x6e, 0x6f, 0x67, 0x63, 0x68, 0xea, 0xea, 0xea, 0xc2, 0x18,
0x1d, 0x1f, 0x0f, 0x07, 0x92, 0xbc, 0x3e, 0xbf, 0xb3, 0xb7, 0xbc, 0xbd, 0x1f, 0x9f, 0xf7, 0xf5,
0x75, 0x31, 0x00, 0x80, 0x83, 0xdf, 0xff, 0xf8, 0xf8, 0x1c, 0x0c, 0x06, 0x87, 0x83, 0x81, 0x88,
0x98, 0xd8, 0xfb, 0xfd, 0xbe, 0x9f, 0x9f, 0x19, 0x98, 0xeb, 0xf1, 0x78, 0x1e, 0x0f, 0x1f, 0xbf,
0xfc, 0xe4, 0xe4, 0x3c, 0x3c, 0x1c, 0x1c, 0x0c, 0x00, 0x00, 0x44, 0x66, 0x27, 0xb7, 0x9b, 0x98,
0xcc, 0xce, 0x7f, 0x7f, 0x37, 0x67, 0x74, 0xfc, 0xfc, 0xcc, 0x9c, 0x1c, 0x08, 0x0e, 0x07, 0x03,
0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x67, 0x67, 0x67, 0x64, 0x74, 0x7d,
0x7d, 0x7f, 0x7f, 0x77, 0x37, 0x35, 0x35, 0x35, 0x35, 0x35, 0x36, 0x37, 0x27, 0x21, 0x20, 0x20,
0x28, 0x2c, 0x26, 0x03, 0x09, 0x08, 0x8a, 0xea, 0x72, 0x3a, 0x1c, 0x4e, 0x27, 0x33, 0x19, 0x18,
0x1c, 0x0e, 0x07, 0x03, 0x01, 0x00, 0x00, 0x03, 0x0f, 0x1e, 0x18, 0x80, 0x60, 0x31, 0x19, 0x0f,
0x07, 0x03, 0x01, 0x01, 0x11, 0x19, 0x0c, 0x0f, 0x03, 0x31, 0x18, 0x0c, 0x06, 0x07, 0x03, 0x01,
0x01, 0x01, 0x03, 0x0f, 0x1e, 0x78, 0x70, 0x64, 0x06, 0x06, 0x02, 0x03, 0x23, 0x3f, 0x3f, 0x3f,
0x27, 0x22, 0x22, 0x22, 0x22, 0x22, 0x32, 0x3e, 0x3f, 0x3f, 0x1f, 0x03, 0x03, 0x02, 0x06, 0x04,
0x0c, 0x08, 0x18, 0x10, 0x30, 0x20, 0x60, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x04, 0x02, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00    };

    oled_write_raw_P(qmk_logo, sizeof(qmk_logo));
}

#define RAW_EPSIZE 32
char mode = 'l';
char status[RAW_EPSIZE] = "_";
char status_prev[RAW_EPSIZE] = "";

static uint16_t percent_timer;

bool oled_task_user(void) {
    oled_on();

    if (mode == 'p' && timer_elapsed(percent_timer) > 1000) {
       status[0] = '_';
       status_prev[0] = ' ';
       mode = 'l';
    }

    if (strcmp(status, status_prev) != 0) {
        oled_clear();
        if (mode == 'l') {
            render_logo();
        } else if (mode == 'p') {
            int percent = atoi(status);
            int pixels = percent * OLED_DISPLAY_WIDTH / 100;

            for(int x = 0; x < pixels; x++)
            {
                for(int y = 0; y < OLED_DISPLAY_HEIGHT; y++)
                {
                    oled_write_pixel(x, y, true);
                }
            }
        } else {
            oled_write_P(PSTR(status), false);
        }
        for(int i = 0; i < RAW_EPSIZE; i++)
        {
            status_prev[i] = status[i];
        }
    }
    return false;
}

#endif

#ifdef RAW_ENABLE

void raw_hid_receive(uint8_t *data, uint8_t length) {
    mode = data[0];

    if (mode == 'p') {
        percent_timer = timer_read();
    }

    for(int i = 1; i < length; i++)
    {
        status[i-1] = data[i];
    }

}

#endif
